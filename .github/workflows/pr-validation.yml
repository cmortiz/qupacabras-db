name: PR Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'submissions/**'

jobs:
  validate-submissions:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: submissions/**

    - name: Validate benchmark submissions
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ” Validating benchmark submissions with enhanced schema validation..."
        
        # Track validation results
        VALIDATION_FAILED=0
        VALIDATED_FOLDERS=""
        
        # Get unique submission folders from changed files
        SUBMISSION_FOLDERS=$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | \
          grep "^submissions/" | \
          cut -d'/' -f2 | \
          grep -v "template" | \
          sort -u || true)
        
        if [ -z "$SUBMISSION_FOLDERS" ]; then
          echo "No submission folders to validate"
          exit 0
        fi
        
        # Validate each submission folder
        for folder in $SUBMISSION_FOLDERS; do
          echo "ğŸ“ Validating submission: $folder"
          
          # Check if benchmark.json exists
          if [ ! -f "submissions/$folder/benchmark.json" ]; then
            echo "âŒ Missing benchmark.json in submissions/$folder/"
            VALIDATION_FAILED=1
            continue
          fi
          
          # Use the enhanced validation script
          if node scripts/validate-benchmark.js --file "submissions/$folder/benchmark.json"; then
            echo "âœ… Submission $folder passed validation"
            VALIDATED_FOLDERS="$VALIDATED_FOLDERS $folder"
          else
            echo "âŒ Submission $folder failed validation"
            VALIDATION_FAILED=1
          fi
          
          echo ""
        done
        
        # Store validated folders for later use
        echo "VALIDATED_FOLDERS=$VALIDATED_FOLDERS" >> $GITHUB_ENV
        
        # Exit with error if any validation failed
        if [ $VALIDATION_FAILED -eq 1 ]; then
          echo "âŒ One or more submissions failed validation"
          exit 1
        fi

    - name: Test benchmark generation
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ”§ Testing benchmark index generation with duplicate detection..."
        
        # Run the generation and capture output
        OUTPUT=$(npm run generate-index 2>&1)
        echo "$OUTPUT"
        
        # Check if the generated file is valid JSON
        if ! jq empty public/benchmarks.json 2>/dev/null; then
          echo "âŒ Generated benchmarks.json is not valid JSON"
          exit 1
        fi
        
        # Check for duplicate warnings
        if echo "$OUTPUT" | grep -q "Potential duplicates detected"; then
          echo "âš ï¸  Warning: Potential duplicate submissions detected"
          echo "Please review the warnings above"
        fi
        
        echo "âœ… Benchmark index generated successfully"

    - name: Comment on PR
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const changedFilesStr = '${{ steps.changed-files.outputs.all_changed_files }}';
          const changedFiles = changedFilesStr.split(/\s+/).filter(Boolean);

          const submissionFolders = [...new Set(
            changedFiles
              .filter(file => file.startsWith('submissions/'))
              .map(file => file.split('/')[1])
              .filter(folder => folder !== 'template')
          )];

          if (submissionFolders.length === 0) {
            return;
          }

          const validatedFoldersEnv = process.env.VALIDATED_FOLDERS || '';
          const validatedFolders = validatedFoldersEnv.trim().split(/\s+/).filter(Boolean);

          const formattedValidated = validatedFolders.length
            ? validatedFolders.map(f => `\`${f}\``).join(', ')
            : '_None_';

          const comment = `## ğŸ§ª Benchmark Submission Validation

          **Validated submissions:** ${formattedValidated}

          âœ… All validations passed! The benchmark data has been validated for:
          - **JSON Schema compliance** with comprehensive field validation
          - **Quantum-specific properties** (qubit count, gate count, circuit depth)
          - **QASM file existence and syntax** (if specified)
          - **Numeric field validation** with appropriate ranges
          - **URL format validation**
          - **Duplicate detection** across submissions
          - **Timestamp format** (ISO 8601)
          - **ID/folder name matching**

          ### Enhanced Validation Features:
          - ğŸ“‹ Validates against formal JSON Schema
          - ğŸ”¬ Quantum-specific field validation (qubits, gates, depth)
          - ğŸ” Automatic duplicate submission detection
          - âš ï¸  Warnings for missing recommended fields
          - ğŸ›¡ï¸  Pre-commit hook ready for local validation

          Your submission is ready for review by maintainers.`;

                    await github.rest.issues.createComment({
                      issue_number: context.issue.number,
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      body: comment
                    });
          }