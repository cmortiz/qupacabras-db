name: Test Auto-populate PR Metadata

on:
  workflow_dispatch:
    inputs:
      test_username:
        description: 'Test username to use'
        required: true
        default: 'test-user'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create test submission
        run: |
          mkdir -p submissions/test_auto_populate
          cat > submissions/test_auto_populate/benchmark.json << 'EOF'
          {
            "algorithmName": "Test Algorithm",
            "device": "Test Device",
            "metricName": "Success Rate",
            "metricValue": 0.99
          }
          EOF
          
      - name: Run add-pr-metadata script
        run: |
          chmod +x scripts/add-pr-metadata.js
          node scripts/add-pr-metadata.js submissions/test_auto_populate/benchmark.json "${{ github.event.inputs.test_username }}" "2025-07-24T10:30:00Z"
          
      - name: Verify contributor and timestamp were added
        run: |
          echo "Contents of benchmark.json after adding contributor:"
          cat submissions/test_auto_populate/benchmark.json
          
          # Verify contributor field exists and matches
          CONTRIBUTOR=$(jq -r '.contributor' submissions/test_auto_populate/benchmark.json)
          if [ "$CONTRIBUTOR" = "${{ github.event.inputs.test_username }}" ]; then
            echo "✅ Success: Contributor field correctly added"
          else
            echo "❌ Failed: Expected contributor '${{ github.event.inputs.test_username }}', got '$CONTRIBUTOR'"
            exit 1
          fi
          
          # Verify timestamp field exists
          TIMESTAMP=$(jq -r '.timestamp' submissions/test_auto_populate/benchmark.json)
          if [ "$TIMESTAMP" = "2025-07-24T10:30:00Z" ]; then
            echo "✅ Success: Timestamp field correctly added"
          else
            echo "❌ Failed: Expected timestamp '2025-07-24T10:30:00Z', got '$TIMESTAMP'"
            exit 1
          fi
          
      - name: Test idempotency
        run: |
          # Run again - should not modify
          node scripts/add-pr-metadata.js submissions/test_auto_populate/benchmark.json "different-user" "2025-07-25T12:00:00Z"
          
          # Verify they didn't change
          CONTRIBUTOR=$(jq -r '.contributor' submissions/test_auto_populate/benchmark.json)
          TIMESTAMP=$(jq -r '.timestamp' submissions/test_auto_populate/benchmark.json)
          if [ "$CONTRIBUTOR" = "${{ github.event.inputs.test_username }}" ]; then
            echo "✅ Success: Contributor field was not overwritten"
          else
            echo "❌ Failed: Contributor was overwritten to '$CONTRIBUTOR'"
            exit 1
          fi
          if [ "$TIMESTAMP" = "2025-07-24T10:30:00Z" ]; then
            echo "✅ Success: Timestamp field was not overwritten"
          else
            echo "❌ Failed: Timestamp was overwritten to '$TIMESTAMP'"
            exit 1
          fi
          
      - name: Cleanup
        if: always()
        run: |
          rm -rf submissions/test_auto_populate